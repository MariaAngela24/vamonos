{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="row">
<!-- Nearby Events -->
	<div class="col-xs-3">
		<div id="nearby-events" class="content" data-latitude={{ latitude }} data-longitude={{ longitude }}>
			<h4>Nearby Events</h4>
			<ul id="events-list">
			</ul>
		</div>
	</div>
	<div class="col-xs-9">
		<div>
			<div class="row">
<!-- Permissions -->
				<div class="col-xs-12 col-sm-6">
					<div class="content floater-box">
						<h4>Permissions</h4>
						{% if session['user_id'] == admin_id %}
						<form action="/add_permission" method="POST" >
							
							<div "form-group">
								Add:
								<label>
									<select name="friend_id">
										{% for name, friend_id in friends %}
											<option value={{ friend_id }}>{{ name }}</option>
										{% endfor %}
									</select>
								</label>
							
								<label>
									<input type="radio" name="can_edit" value=0 >View Only
								</label>

								<label>
									<input type="radio" name="can_edit" value=1 >View & Edit
								</label>
								
								<label>
									<input type="hidden" name="trip_id" value={{ trip_id }}>
								</label>

								<label>
									<input type="submit" value="+" class="btn btn-info btn-xs">
								</label>
							</div>
						</form>
						{% endif %}
						<ul>
							{% for perm in permissions %}
								<li><a href="/user{{ perm.user_id }}/profile">{{ perm.user.fname }}</a>
								{% if perm.can_edit %}
									(editor)
								{% endif %}
								</li>
							{% endfor %}
						</ul>
					</div>
				</div>
<!-- Details -->
				<div class="col-xs-12 col-sm-6">
					<div class="content floater-box">
						<h4>Details</h4>
					</div>
				</div>
			</div>
			<div class="row">	
<!-- Agenda -->
				<div class="col-xs-12" data-trip={{ trip.trip_id }} data-start={{ trip_start_str }} data-end={{ trip_end_str }}>
					<div class="content" id="agenda">
						<h4>Agenda</h4>
						<div>
							{% for day in trip.days %}
								<div class="day">Day {{ day.day_num }}
									<ul>
										{% for event in day.events %}
											<li>{{ event.title }}</li>
										{% endfor %}
									</ul>
								</div>

							{% endfor %}
						</div>


						<!-- Modal Button -->
						<button type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal">Create Event</button>

						<!-- Modal Window-->
						<div id="myModal" class="modal fade" role="dialog">
						  <div class="modal-dialog">

						    <!-- Modal content-->
						    <div class="modal-content">
						      <div class="modal-header">
						        <button type="button" class="close" data-dismiss="modal">&times;</button>
						        <h4 class="modal-title">Create Event</h4>
						      </div>
						      <div class="modal-body">
	<!-- Create Event Form -->
						        <form action="/create_event" method="POST">
						        	<label>Title:
						        		<input name="title" type="text" placeholder="Balloonicorn's Fiesta">
						        	</label>
						        	<label>Start:
						        		<input name="start" type="datetime-local">
						        	</label>
						        	<label>End:
						        		<input name="end" type="datetime-local">
						        	</label>
						        	<label>
						        		<input name="city" type="hidden" value={{ trip.city }}>
						        	</label>
						        	<label>
						        		<input type="submit" value="Submit">
						        	</label>
						        </form>
						        
						      </div>
						      <div class="modal-footer">
						        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						      </div>
						    </div>

						  </div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}



{% block scripts %}
<script>

// loads events into the "nearby events" div.
function getEvents() {

	$.get("/token", function (result) {
		var parsedJSON = JSON.parse(result);
		var token = parsedJSON.token

		var tripId = $("#agenda").data("trip");
		var latitude = $("#nearby-events").data("latitude");
		var longitude = $("#nearby-events").data("longitude");

		var trip_start = $("#agenda").data("start");
		var trip_end = $("#agenda").data("end");

		var data = {token: token,
					"location.latitude": latitude,
					"location.longitude": longitude,
					"location.within": "10mi",
					"start_date.range_start": trip_start,
					"start_date.range_end": trip_end
					},
			url = "https://www.eventbriteapi.com/v3/events/search/"

			// request events
			$.get(url, data, function(result) {
				var topEvents = result.events.slice(0,10);
			

				// add event names to the dom
				topEvents.forEach(function(event) {
							var nameLink = $('<a>')
								.attr('href', event.url)
								.attr('target', "_blank")
								.text(event.name.text)
							var addButton = $('<a>')
								.attr('href', "/add_event/" + event.id + "/" + tripId)
								.text('+')
							alert(tripId)

							$("#events-list").append(addButton)
											 .append(nameLink)
											 .append('<br><br>')
				});
			});
	});
};

$(document).on("ready", getEvents);

</script>
{% endblock %}